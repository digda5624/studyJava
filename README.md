# 내 코드들은 어떻게 실행이 될까

프로그램이란?<br>
0과 1로 된, 컴퓨터에게 어떤 동작을 실행하라는 명령어들의 집합이다. 실행하게 되면
프로그램이라 불리는 명령어들이 메인 메모리(RAM) 에 배치된다. 이 상태를 프로세스라고 한다.

기계어는 CPU 마다 다르다.

따라서 컴파일러 들은 나의 코드를 기계어로 바꿔주어야 한다. (어셈블리어로 교체 후 어셈블러가 기계어로 바꿔 주기도 함)

또 운영체제 위에서 실행을 하기 위해서는 실행파일을 만들어야 한다. 또한 운영체제 별로 실행파일이 다르다.

따라서 기계어를 실행파일로 바꿔줘야하는 수단이 필요하고 각 운영체제에 맞게 기계어들을 묶어주어야 하는 개체가 필요하다.<br>
이를 링커라고 한다.

따라서 흐름은 다음과 같아진다.

소스파일 -> 컴파일러 -> (어셈블리어 -> 어셈블러) -> 오브젝트 파일(목적 파일) -> 링커 -> 실행파일

## 그렇다면 java 는?
JVM 을 이용하여 실행이 된다.

1. 프로그램이 실행되면 JVM은 OS로부터 이프로그램이 필요로 하는 메모리를 할당 받는다.(이 때 JVM은 이 메모리를 용도에 따라
여러 영역으로 나누어 관리한다.)
2. 자바 파일(java)이 자바 컴파일러에 의해 자바 바이트 코드(.class)로 변환 된다(이 .class 파일은 JVM이 읽을 수 있다.)
3. 클래스 로더를 통해 자바 바이트 코드를 JVM으로 필요한 시점에 로딩한다.
4. 해석된 바이트 코드는 런타임 데이터 영역에 배치되어 실질적인 수행이 이루어지게 된다.
5. 실행 과정 속에서 JVM은 필요에 따라 GC와 같은 관리 작업을 수행한다.
6. JVM 과 운영체제 간 소통은 실행 엔진에 의해 이루어지게 된다. (실행 엔진에서 기계어로 번역하여 운영체제에게 전달)

따라서 운영체제 별로 JVM 이 다르다

정말 간단하게 말해 나의 컴퓨터에 java언어를 해석하기 위한 통역사를 두는 것이다. 여기서 통역사는 말그대로 머신에 맞게 컴퓨터와 거의 같은
메모리 구조를 가지고 있다.

### 클래스 로더
자바는 동적 로드, 즉 컴파일 타임이 아니라 런타임(바이트 코드를 실행 할 때)에 클래스를 로드하고 링크하는 특징이 있다.

클래스 로더에는 로딩, 링크, 초기화 단계로 나뉘어져 있다.

* 로드
  * 각 자바 바이트 코드(.class)는 JVM에 의해 메소드 영역에 다음 정보를 저장한다.
    * 로드된 클래스를 비롯한 그의 부모 클래스 정보
    * 클래스 파일과 Class, interface, Enum의 관련 여부
    * 변수나 메소드 등의 정보


* 링크
  * 검증 : 읽어 들인 클래스가 자바 언어 명세 및 JVM 명세에 명시된 대로 잘 구성되어 있는지 검사
  * 준비 : 클래스가 필요로 하는 메모리를 할당하고, 클래스에서 정의된 필드, 메소드, 인터페이스를 나타내는 데이터 구조를 준비
  * 분석 : 심볼릭 메모리 레퍼런스를 메소드 영역에 있는 실제 레퍼런스로 교체


* 초기화
  * 클래스 변수를 적절한 값으로 초기화. static 필드들이 설정된 값으로 초기화

### java 의 런타임 메모리 영역 (런타임 데이터)
런타임 데이터 영역이라고 하며 JVM 이 운영 체제 위에서 실행될 때, 할당 받는 메모리 영역이며 총 6개의 영역으로 나눌 수 있다.
이 영역들은 스레드가 공유하는 공간인지 아닌지로 나눈다.

* 스레드마다 하나씩 생성되는 공간
  * PC 레지스터
  * JVM 스택
  * 네이티브 메소드 스택

* 모든 스레드가 공유하는 공간
  * 힙
  * 메소드
  * 런타임 상수 풀

#### PC 레지스터
정말 말그대로 Program Counter를 의미한다 각 스레드 마다 하나 씩 존재하며 메소드 안에서 바이트 코드 몇 번째 줄을 실행하고 있는지와 같은 정보를
포함하고 있다.

#### JVM 스택
JVM 스택은 각 스레드 마다 하나씩 존재하며, 스레드가 시작될 때 생성된다.<br>
JVM 스택은 스택 프레임이라는 구조체로 이루어져 있는데, 새로운 메소드가 호출될 때마다 push, 메소드 실행이 끝나면 pop 동작을 수행<br>
각 스택 프레임은 지역 변수 배열, 피연산자, 프레임 데이터를 가진다. 

프레임 데이터는 현재 실행 중인 메소드가 속한 클래스의 런타임 상수 풀, 이전 프텍 프레임에 대한 정보, 현재 메소드가 속한 클래스, 객체에 대한 참조 등을 말한다.

#### 힙 영역
힙은 모든 스레드가 공유하는 영역

힙은 프로그램을 실행하면서 생성된 모든 인스턴스 또는 객체를 저장하는 공간

#### 메소드 영역
모든 스레드가 공유하는 영역으로 JVM이 시작될 때 생성된다.<br>
클래스 로더가 클래스 파일을 읽어 오면, 클래스 정보를 파싱하여 런타임 상수 풀, 필드와 메소드 정보, static 변수, 메소드의 바이트 코드 등을 보관<br>

#### 런타임 상수 풀


### 실행 엔진
실행 엔진은 메모리에 적재된 바이트 코드(.class)를 기계어로 변경하여 명령어 단위로 실행 및 바이트 코드를 
운영 체제에 맞게 해석해주는 역할을 수행한다. 실행 엔진이 바이트 코드를 명령어 단위로 읽어서 수행하는데는 2가지 방식이 사용된다.

1. 인터프리터
   * 런타임 중에 바이트 코드를 한 줄씩 읽고 실행한다.
   * 컴파일 보다 속도가 느리다.

2. JIT(just in time)
   * 인터프리터의 속도 이슈를 해결하기 위해 같이 사용
   * 자주 실행되는 바이트 코드 영역을 런타임 중에 기계어로 컴파일 하여 사용